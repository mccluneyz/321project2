@{
    ViewData["Title"] = "Recycling Hero";
}

<!-- Load Phaser FIRST in head to ensure it's in global scope before ANY other scripts -->
<script src="~/lib/phaser.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        overflow: auto;
        background: #000;
    }
    
    #game-container {
        width: 100%;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 10px;
        box-sizing: border-box;
        background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%);
    }
    
    canvas {
        display: block;
        width: auto !important;
        height: auto !important;
        max-width: calc(100vw - 30px);
        max-height: calc(100vh - 120px);
        border: 3px solid #4CAF50;
        box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        margin: 10px auto;
        object-fit: contain;
    }
    
    #loading-message {
        color: white;
        font-family: Arial, sans-serif;
        font-size: 20px;
        text-align: center;
        margin-top: 50px;
    }
    
    /* Level Select Menu - ADMIN ONLY */
    #level-select-toggle {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #f44336;  /* Red for admin */
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-family: Arial, sans-serif;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(244, 67, 54, 0.5);
        z-index: 1000;
        transition: all 0.3s;
    }
    
    #level-select-toggle:hover {
        background: #d32f2f;  /* Darker red on hover */
        transform: scale(1.05);
    }
    
    #level-select-menu {
        position: fixed;
        top: 80px;
        right: -350px;
        width: 320px;
        height: calc(100vh - 100px);
        background: #0f0f1e;
        border: 3px solid #4CAF50;
        border-radius: 8px 0 0 8px;
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
        transition: right 0.3s ease;
        z-index: 999;
        color: white;
        font-family: Arial, sans-serif;
    }
    
    #level-select-menu.active {
        right: 0;
    }
    
    .world-section {
        margin-bottom: 20px;
    }
    
    .world-section h4 {
        color: #4CAF50;
        margin: 10px 0;
        font-size: 16px;
    }
    
    .level-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
    }
    
    .level-grid button {
        background: #2196F3;
        color: white;
        border: none;
        padding: 10px 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s;
    }
    
    .level-grid button:hover {
        background: #1976D2;
        transform: scale(1.05);
    }
    
    /* Info Button */
    #info-toggle {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: #2196F3;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 4px 10px rgba(33, 150, 243, 0.5);
        z-index: 1000;
        transition: all 0.3s;
    }
    
    #info-toggle:hover {
        background: #1976D2;
        transform: scale(1.05);
    }
    
    /* Info Modal */
    #info-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
    }
    
    #info-modal.active {
        display: flex;
    }
    
    .info-content {
        background: #1a1a2e;
        border: 4px solid #2196F3;
        border-radius: 12px;
        padding: 30px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        margin: 20px;
    }
    
    .info-content h2 {
        color: #2196F3;
        margin-top: 0;
        font-size: 32px;
        text-align: center;
        border-bottom: 2px solid #2196F3;
        padding-bottom: 10px;
    }
    
    .info-content h3 {
        color: #4CAF50;
        margin-top: 20px;
        font-size: 24px;
    }
    
    .info-content p, .info-content ul {
        color: #fff;
        line-height: 1.8;
        font-size: 16px;
    }
    
    .info-content ul {
        padding-left: 25px;
    }
    
    .info-content li {
        margin-bottom: 10px;
    }
    
    .info-close {
        float: right;
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        margin-top: -10px;
    }
    
    .info-close:hover {
        background: #d32f2f;
    }
    
    .info-section {
        background: #252540;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    }
    
</style>

<div id="game-container">
    <div id="loading-message">Loading Recycling Hero...</div>
</div>

<!-- Level Select Menu - ADMIN ONLY -->
<div id="level-select-toggle" onclick="toggleLevelMenu()">
    üîí ADMIN: Levels
</div>

<!-- Info Button -->
<div id="info-toggle" onclick="toggleInfoModal()">
    ‚ÑπÔ∏è Game Info
</div>

<div id="level-select-menu">
    <div style="padding: 15px; border-bottom: 2px solid #f44336; background: #1a1a2e;">
        <h3 style="margin: 0; color: #f44336;">ADMIN: Level Select</h3>
        <button onclick="toggleLevelMenu()" style="float: right; margin-top: -25px; background: #f44336; border: none; color: white; padding: 5px 10px; cursor: pointer; border-radius: 3px;">‚úï</button>
    </div>
    <div style="padding: 15px; overflow-y: auto; max-height: calc(100vh - 200px);">
        <!-- World 1: City/Forest -->
        <div class="world-section">
            <h4>üèôÔ∏è World 1: City Forest</h4>
            <div class="level-grid">
                <button onclick="jumpToLevel('Level_1_1')">1-1</button>
                <button onclick="jumpToLevel('Level_1_2')">1-2</button>
                <button onclick="jumpToLevel('Level_1_3')">1-3</button>
                <button onclick="jumpToLevel('Level_1_4')">1-4</button>
                <button onclick="jumpToLevel('Level_1_5_Boss')" style="background: #f44336;">1-5 Boss</button>
            </div>
        </div>
        
        <!-- World 2: Desert -->
        <div class="world-section">
            <h4>üèúÔ∏è World 2: Desert Dunes</h4>
            <div class="level-grid">
                <button onclick="jumpToLevel('Level_2_1')">2-1</button>
                <button onclick="jumpToLevel('Level_2_2')">2-2</button>
                <button onclick="jumpToLevel('Level_2_3')">2-3</button>
                <button onclick="jumpToLevel('Level_2_4')">2-4</button>
                <button onclick="jumpToLevel('Level_2_5_Boss')" style="background: #f44336;">2-5 Boss</button>
            </div>
        </div>
        
        <!-- World 3: Factory/Mountains -->
        <div class="world-section">
            <h4>üèîÔ∏è World 3: Mountain Peaks</h4>
            <div class="level-grid">
                <button onclick="jumpToLevel('Level_3_1')">3-1</button>
                <button onclick="jumpToLevel('Level_3_2')">3-2</button>
                <button onclick="jumpToLevel('Level_3_3')">3-3</button>
                <button onclick="jumpToLevel('Level_3_4')">3-4</button>
                <button onclick="jumpToLevel('Level_3_5_Boss')" style="background: #f44336;">3-5 Boss</button>
            </div>
        </div>
        
        <!-- World 4: Ocean -->
        <div class="world-section">
            <h4>üåä World 4: Ocean Depths</h4>
            <div class="level-grid">
                <button onclick="jumpToLevel('Level_4_1')">4-1</button>
                <button onclick="jumpToLevel('Level_4_2')">4-2</button>
                <button onclick="jumpToLevel('Level_4_3')">4-3</button>
                <button onclick="jumpToLevel('Level_4_4')">4-4</button>
                <button onclick="jumpToLevel('Level_4_5_Boss')" style="background: #f44336;">4-5 Boss</button>
            </div>
        </div>
        
        <!-- World 5: Wasteland -->
        <div class="world-section">
            <h4>‚ò£Ô∏è World 5: Toxic Wasteland</h4>
            <div class="level-grid">
                <button onclick="jumpToLevel('Level_5_1')">5-1</button>
                <button onclick="jumpToLevel('Level_5_2')">5-2</button>
                <button onclick="jumpToLevel('Level_5_3')">5-3</button>
                <button onclick="jumpToLevel('Level_5_4')">5-4</button>
                <button onclick="jumpToLevel('Level_5_5_Boss')" style="background: #f44336;">5-5 Boss</button>
            </div>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div id="info-modal">
    <div class="info-content">
        <button class="info-close" onclick="toggleInfoModal()">‚úï Close</button>
        <h2>üéÆ Recycling Hero - Game Guide</h2>
        
        <div class="info-section">
            <h3>üéØ Game Objective</h3>
            <p>Navigate through 5 worlds of pollution, defeat bosses, and reach heaven by collecting the Holy Recycling Bin!</p>
        </div>
        
        <div class="info-section">
            <h3>üïπÔ∏è Controls</h3>
            <ul>
                <li><strong>Move:</strong> WASD or Arrow Keys</li>
                <li><strong>Jump:</strong> W or Up Arrow (Double jump available later)</li>
                <li><strong>Attack:</strong> Shift - Throw recyclables at enemies</li>
                <li><strong>Shield:</strong> Q - Block attacks from the front</li>
                <li><strong>Sword:</strong> R - Melee attack (unlocked in World 3)</li>
                <li><strong>Glider:</strong> Hold Space in air (unlocked in World 4)</li>
                <li><strong>Pause:</strong> ESC - Open pause menu</li>
            </ul>
        </div>
        
        <div class="info-section">
            <h3>üõ°Ô∏è Metal Skin Mechanic</h3>
            <p><strong>Metal Skin</strong> is a defensive state some enemies enter when they take damage. When an enemy has metal skin:</p>
            <ul>
                <li>‚ùå They become <strong>immune to recyclable projectiles</strong></li>
                <li>‚úÖ Only your <strong>sword (R key)</strong> can damage them</li>
                <li>‚öîÔ∏è Metal skin appears as a metallic gray overlay on the enemy</li>
                <li>üí° Strategy: Save your sword attacks for metal-skinned enemies!</li>
            </ul>
        </div>
        
        <div class="info-section">
            <h3>üëπ Bosses</h3>
            <p>Each world ends with a powerful Pollution Boss:</p>
            <ul>
                <li><strong>World 1 (City):</strong> Weak boss - learn the basics</li>
                <li><strong>World 2 (Desert):</strong> Shoots projectiles</li>
                <li><strong>World 3 (Factory):</strong> Fast and aggressive</li>
                <li><strong>World 4 (Ocean):</strong> Ranged attacks and high HP</li>
                <li><strong>World 5 (Wasteland):</strong> Final boss with <strong>Final Stand</strong> phase</li>
            </ul>
            <p><strong>Final Stand:</strong> When the final boss reaches 25% health, it becomes invincible and you must survive for 60 seconds while dodging powerful attacks including air strikes!</p>
        </div>
        
        <div class="info-section">
            <h3>üåç Level Design</h3>
            <ul>
                <li><strong>5 Worlds:</strong> City, Desert, Factory, Ocean, Wasteland</li>
                <li><strong>5 Levels per World:</strong> 4 regular levels + 1 boss level</li>
                <li><strong>Progressive Difficulty:</strong> Enemies get stronger as you advance</li>
                <li><strong>Item Unlocks:</strong> Gain new abilities as you complete worlds</li>
            </ul>
        </div>
        
        <div class="info-section">
            <h3>üéÅ Items & Upgrades</h3>
            <ul>
                <li><strong>Shield:</strong> Start - Block frontal attacks with Q</li>
                <li><strong>Double Jump:</strong> World 2 - Jump twice in the air</li>
                <li><strong>Sword:</strong> World 3 - Melee attack with R, works on metal skin</li>
                <li><strong>Glider:</strong> World 4 - Hold Space in air to slow fall</li>
            </ul>
        </div>
        
        <div class="info-section">
            <h3>üèÜ Game Stats & Scoring</h3>
            <p>After completing the game, your performance is scored based on:</p>
            <ul>
                <li>‚è±Ô∏è <strong>Time:</strong> Faster completion = higher score</li>
                <li>üó°Ô∏è <strong>Enemies Killed:</strong> More kills = more points</li>
                <li>‚öîÔ∏è <strong>Damage Dealt:</strong> Attack efficiency matters</li>
                <li>üíÄ <strong>Deaths:</strong> Each death reduces your score</li>
                <li>ü©∏ <strong>Damage Taken:</strong> Less damage = better score</li>
            </ul>
            <p><strong>Best Score:</strong> ~100 coins (requires perfect run with no deaths!)</p>
        </div>
        
        <div class="info-section">
            <h3>üí° Tips & Strategies</h3>
            <ul>
                <li>üõ°Ô∏è Use your shield proactively - blocking saves health!</li>
                <li>‚öîÔ∏è Save sword attacks for metal-skinned enemies</li>
                <li>ü¶Ö The glider is essential for dodging during the final boss</li>
                <li>üíö Don't rush - taking less damage improves your final score</li>
                <li>üéØ Practice boss patterns - memorize attack timings</li>
                <li>üîÑ Use the pause menu (ESC) to reset stages if needed</li>
            </ul>
        </div>
        
        <p style="text-align: center; color: #888; margin-top: 30px; font-style: italic;">
            Good luck, Recycling Hero! üåç‚ôªÔ∏è
        </p>
    </div>
</div>

<!-- Level Select Menu Functions -->
<script>
    function toggleLevelMenu() {
        const menu = document.getElementById('level-select-menu');
        menu.classList.toggle('active');
    }
    
    function toggleInfoModal() {
        const modal = document.getElementById('info-modal');
        modal.classList.toggle('active');
    }
    
    function jumpToLevel(levelKey) {
        // Get the Phaser game instance
        const game = window.phaserGame;
        if (!game) {
            console.error('Game not loaded yet!');
            alert('Please wait for the game to load first!');
            return;
        }
        
        // Stop all current scenes
        game.scene.scenes.forEach(scene => {
            if (scene.scene.isActive()) {
                scene.sound.stopAll();
                scene.scene.stop();
            }
        });
        
        // Start the selected level
        game.scene.start(levelKey);
        
        // Close the menu
        toggleLevelMenu();
        
        console.log('Jumped to level:', levelKey);
    }
</script>

<!-- Game loader - runs after Phaser is guaranteed to be loaded -->
<script>
    (async function() {
        // Verify Phaser loaded
        if (typeof Phaser === 'undefined') {
            console.error('‚ùå Phaser failed to load');
            document.getElementById('loading-message').innerHTML = 'Failed to load Phaser.<br>Please refresh the page.';
            return;
        }
        
        if (typeof Phaser.Scene === 'undefined') {
            console.error('‚ùå Phaser.Scene is not defined');
            document.getElementById('loading-message').innerHTML = 'Phaser did not load correctly.<br>Please refresh the page.';
            return;
        }
        
        console.log('‚úÖ Phaser ready:', Phaser.VERSION);
        
        // Web Audio API for level complete sound (fallback)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playLevelCompleteSound = (vol = 0.15) => {
            // Nice ascending melody
            [523, 659, 784, 1047].forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    osc.start(audioCtx.currentTime);
                    osc.stop(audioCtx.currentTime + 0.3);
                }, i * 100);
            });
        };
        
        // Patch Phaser Sound Manager to ONLY intercept level_complete_sound
        const originalPlay = Phaser.Sound.BaseSoundManager.prototype.play;
        Phaser.Sound.BaseSoundManager.prototype.play = function(key, config) {
            // ONLY intercept level_complete_sound, let everything else pass through
            if (key === 'level_complete_sound') {
                const volume = config?.volume || 0.15;
                playLevelCompleteSound(volume);
                return null;
            }
            
            // All other sounds play normally
            return originalPlay.call(this, key, config);
        };
        
        const originalAdd = Phaser.Sound.BaseSoundManager.prototype.add;
        Phaser.Sound.BaseSoundManager.prototype.add = function(key, config) {
            try {
                if (!this.game.cache.audio.exists(key)) {
                    if (!missingAudio.has(key)) {
                        missingAudio.add(key);
                        console.warn('üîá Audio not in cache:', key);
                    }
                    // Return a dummy sound object that does nothing
                    return {
                        play: () => {},
                        stop: () => {},
                        pause: () => {},
                        resume: () => {},
                        destroy: () => {},
                        setVolume: () => {},
                        setLoop: () => {},
                        on: () => {},
                        once: () => {},
                        off: () => {}
                    };
                }
                return originalAdd.call(this, key, config);
            } catch (e) {
                if (!missingAudio.has(key)) {
                    missingAudio.add(key);
                    console.warn('üîá Audio add error:', key);
                }
                return {
                    play: () => {},
                    stop: () => {},
                    pause: () => {},
                    resume: () => {},
                    destroy: () => {},
                    setVolume: () => {},
                    setLoop: () => {},
                    on: () => {},
                    once: () => {},
                    off: () => {}
                };
            }
        };
        
        console.log('‚úÖ Audio error handling enabled');
        
        // Give browser a moment to fully process Phaser
        await new Promise(resolve => setTimeout(resolve, 50));
        
        try {
            document.getElementById('loading-message').textContent = 'Loading game modules...';
            const module = await import('@Url.Content("~/js/hero/main.js?v=36")');
            console.log('‚úÖ Game started successfully!');
            // Remove loading message
            const loadingEl = document.getElementById('loading-message');
            if (loadingEl) loadingEl.remove();
        } catch (err) {
            console.error('‚ùå Game error:', err);
            console.error('Stack:', err.stack);
            document.getElementById('loading-message').innerHTML = 
                'Failed to load game:<br>' + err.message + 
                '<br><br><small>Check console (F12) for details</small>';
        }
    })();
</script>
